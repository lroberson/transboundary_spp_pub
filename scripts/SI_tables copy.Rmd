---
title: "SI_table_species"
output: html_document
---

```{r setup, include=FALSE}

library(data.table)
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)
```

## make subset for COUNTRIES table

```{sata subset}

## wgi scores
wdi_scores <- fread("R://TRANSSPP-A2259//tb_spp_v04//combined_eez_summary_wdi_scores.csv")
names(wdi_scores)

wdi <- wdi_scores %>% 
  dplyr::select(c(score,rgn_id_2,rgn_name_short))

## get country area info
dat_area <- fread("R:\\TRANSSPP-A2259\\tb_spp_v04\\combined_eez_summary_areas.csv")
names(dat_area)
View(dat_area %>% arrange(desc(num_spp_tb)))

## add rank for tb species/area 
dat_sub <- dat_area %>%
  mutate(tb_km2 = num_spp_tb/rgn_area_km2,
         rank_tb_km2 = dense_rank(-tb_km2)) 

dat_sub %>% arrange(rank_tb_km2)

## top 100 countries

dat_sub <- dat_sub %>%
  arrange(desc(num_spp_tb)) %>%
  top_n(100, num_spp_tb)
names(dat_sub)

## add area info

dat_sub <- left_join(dat_sub, wdi, by = "rgn_id_2")
head(dat_sub)

dat_sub <- dat_sub %>% dplyr::select(-c(rgn_id_2, num_spp_sc_th))

write_csv(dat_sub, "_results/tables/si_tbl_countries100.csv")

## All countries (cons letters submission)
dat_all <- left_join(dat_sub, wdi, by = "rgn_id_2")

names(dat_all)

dat_all <- dat_all %>% dplyr::select(-c(rgn_id_2, num_spp_sc_th)) %>% arrange(num_spp_tb)

write_csv(dat_all, "_results/tables/si_tbl_countries_all.csv")

## check for ties
library(hablar)

dat_all <- read_csv("_results/tables/si_tbl_countries_all.csv")
names(dat_all)

n_distinct(dat_all$rgn_nam_2) # n = 228

dat_all %>% find_duplicates(num_spp_tb)
## correct the duplicates and rankings manually in excel (easier bc I already did the formatting)

```

