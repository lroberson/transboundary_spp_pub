---
title: "species_lookup"
author: "Leslie Roberson"
date: "2023-07-26"
output: html_document
---

## Summary

lookup table created for a global analysis of marine species ranges for https://doi.org/10.1111/gcb.15844 (Roberson, L. A. et al. 2021. “Multinational Coordination Required for Conservation of over 90% of Marine Species.” Global Change Biology, 1–11). 
Neither database has a lookup table to match a IUCN ID to an AM ID (as of 2020)
Due to inconsistencies in taxonomy or spelling of species names, matching on species name misses matches
Not all species with maps in AM have maps in IUCN, and visa versa
Habitat (marine v terrestrial) delineations are subjective (e.g. for species that use both, estuarine or semi aquatic species) so there is no "marine" v "terrestrial" categorization given in IUCN that is consistent. AquaMaps focuses on marine and aquatic 
For this analysis, which focused on marine/coastal species, some subjective decisions were made (e.g. not counting hippopotomous or cane toads as marine)

*Here I also add the iucn and AM species that are unique to one of the databases*

# comments on AM
AM=AquaMaps
Version 0816D

# comments on IUCN
version 2019.2
Pulled all taxonomic groups that are entirely marine (e.g. cetaceans) and excluded groups that have no marine species (e.g. arachnids). For groups with both, used downloaded the larger group and then used a series of filtering steps to focus on marine and


```{r setup, include=FALSE}

library(here)
library(tidyverse)
library(readxl)
library(data.table)
library(pillar)
library(janitor)

knitr::opts_chunk$set(echo = TRUE)
```

# load species lists to combine
```{r load spp lists}

both <- read_excel(here("_data/lookup_spp_AM_v_iucn_2019_2.xls"), sheet=2)
glimpse(both) # 2568 species
# has kingdom (CAPS) and class (Sentence)

#am <- read_csv(here("_data/am_spp_list.csv"))
#glimpse(am) # 24,938
# does not have class or kingdom. Don't need to use this one

am.only <- read_csv(here("_data/am_only_spp_info.csv"))
glimpse(am.only) # 22,433
# has kingdom (lower) and class (Sentence)
22433 + 2568
am.only$redlist_category <- "aquamaps_only"
am.only$kingdom <- str_to_upper(am.only$kingdom)

iucn <- read_csv(here("_data/iucn_spp_list_2019_2_marine_cleaned.csv"))
glimpse(iucn) # 9,916
iucn <- iucn %>% rename(iucn_sciname=sciname) # has kingdom (CAPS) and class (CAPS)
unique(iucn$class)
iucn %>% filter(is.na(class)) # 16, they're NAs in every col
iucn$class <- str_to_sentence(iucn$class) 
unique(iucn$class) # IUCN has seabirds, AM doesn't

```

# Make full lookup table
including species that are only in one of hte databases
```{r add to lookup}

#<><>< sort out Aquamaps only 
unique(am.only$kingdom)
# [1] "ANIMALIA"  "BACTERIA"  "PLANTAE"   "CHROMISTA" "PROTOZOA" 
# I ended up only using animals and plants, that's why the numbers don't add up to "am_spp_list"
am.only.sub <- am.only %>% select(-phylum) %>% rename(am_sid=species_id, am_sciname=sciname)
glimpse(am.only.sub) # 22,433

#<><>< Now deal with Both: add redlist info
unique(both$iucn_spp_group)
both %>% filter(iucn_spp_group=="NA") %>% distinct(class) # animals - Mammals, fish, shrks
both %>% filter(iucn_spp_group=="TERRESTRIAL_MAMMALS") # 2 species (sea otter and the Eurasian otter) are in AM but called terrestrial in IUCN
both$kingdom <- "ANIMALIA"
glimpse(both) # 2,568
both %>% filter(is.na(class)) # none
both %>% filter(is.na(kingdom)) # none
# the species in both dbs now have class and kingdom, but no Redlist category
glimpse(iucn)
iucn.sub <- iucn %>% select(c(iucn_sid, iucn_sciname, category)) %>% rename(redlist_category=category)
iucn.sub %>% filter(is.na(class))
iucn.missing <- iucn.sub %>% filter(is.na(iucn_sciname)) # deal with these 16 species later
iucn.sub <- iucn.sub %>% filter(!is.na(iucn_sciname))
glimpse(iucn.sub) # 9,900
# add redlist info from iucn to both
both.rl <- left_join(both, iucn.sub, by=c("iucn_sid", "iucn_sciname"))
glimpse(both.rl) # 2,568

# make a column to note alternate or incorrect iucn SIDs
both.rl$iucn_sid_other <- "NA"

n_distinct(both.rl$iucn_sciname) # 2563
both.rl %>% hablar::find_duplicates(iucn_sciname) %>% arrange(iucn_sciname)# 5 problems, it's values in other columsn
# and one that is two species in AM but one in IUCN (Microphis brachyurus ssp. aculeatus)
both.rl <- both.rl %>%
  mutate(iucn_sid_other=case_when(
    iucn_sid==2467 & iucn_sciname=="Balaena mysticetus"~2468,
    iucn_sid==64396 & iucn_sciname=="Epinephelus bruneus"~135381188,
    iucn_sid==132823 & iucn_sciname=="Epinephelus chlorostigma"~118358386,
    iucn_sid==132775 & iucn_sciname=="Actinopterygii Plectropomus pessuliferus"~118359431,
    TRUE~as.numeric(iucn_sid)),
  redlist_category=case_when(
    iucn_sid==64396~"VU",
    iucn_sid==132823~"LC",
    iucn_sciname=="Microphis brachyurus ssp. aculeatus"~"DD",
    iucn_sciname=="Plectropomus pessuliferus"~"LC",
    TRUE~as.character(redlist_category))) %>%
  # remove the duplicaets
  filter(!iucn_sid %in% c(2468, 135381188, 118358386, 118359431))

both.rl %>% filter(is.na(redlist_category)) # 13 species 
# all have alternate iucn sids
missing.rl <- both.rl %>% filter(is.na(redlist_category)) %>% pull(iucn_sciname)

##<><>> get iucn only list
anti_join(iucn.sub, both, by="iucn_sciname") # 7,350
iucn.only <- anti_join(iucn.sub, both, by=c("iucn_sid", "iucn_sciname"))
glimpse(iucn.only) # 7,351
# so there's one species in iucn that's not in AM that changed its IUCN SID

iucn.only %>% filter(iucn_sciname %in% missing.rl) # only sousa chinensis
# correct in both.rl and remove from iucn.only
both.rl <- both.rl %>% 
  mutate(redlist_category=case_when(
    iucn_sciname=="Sousa chinensis"~"VU",
    TRUE~as.character(redlist_category)
  ))
iucn.only <- iucn.only %>% filter(iucn_sciname!="Sousa chinensis")

## add the other RL categories manually
both.rl <- both.rl %>%
  mutate(redlist_category=case_when(
    iucn_sciname=="Crocodylus acutus"~"VU",
    iucn_sciname=="Mesoplodon carlhubbsi"~"DD",
    iucn_sciname=="Mesoplodon layardii"~"LC",
    iucn_sciname=="Pontoporia blainvillei"~"VU",
    iucn_sciname=="Astrotia stokesii"~"LC",
    iucn_sciname=="Enhydrina schistosa"~"LC",
    iucn_sciname=="Pelamis platura"~"LC",
    iucn_sciname=="Lapemis curtus"~"LC",
    iucn_sciname=="Acalyptophis peronii"~"LC",
    iucn_sciname=="Acrochordus granulatus"~"LC",
    iucn_sciname=="Hypleurochilus langi"~"LC",
    iucn_sciname=="Dorosoma petenense"~"LC", 
    TRUE~as.character(redlist_category)),
    class=str_to_sentence(class))

##<><><><<
##<><> Now bind am.only.sub, iucn.only, both
glimpse(am.only.sub) # 22,433
glimpse(iucn.only) # 7,350
glimpse(both.rl) # 2,564
2564 + 7350 + 22433 # 32347
full <- bind_rows(both.rl, iucn.only, am.only.sub)
glimpse(full) # 32,347

table(full$redlist_category)
# aquamaps_only            CR            DD            EN            LC         LR/lc         LR/nt            NT            VU 
#         22433            82          1864           203          6685             1             3           452           624

write_csv(full, here("_data/species_lists/spp_list_iucn_aquamaps.csv")) # will add metadata in excel


```

